---
import type { HTMLTag, Polymorphic } from 'astro/types'

import { cn } from '../../utils'

type Props<Tag extends HTMLTag> = Polymorphic<{ as: Tag }> & {
  as?: string
  title?: string
  href?: string
  variant?: 'button' | 'pill' | 'back' | 'ahead'
  target?: string
  class?: string
  useHistoryBack?: boolean
}

const { as: Tag = 'a', class: className, title, href, variant = 'button', useHistoryBack = false, ...props } = Astro.props
---

<Tag
  class={cn(
    'group inline-flex items-center gap-x-1 rounded-lg bg-muted border px-2 py-1 text-sm text-muted-foreground transition-all hover:bg-card no-underline',
    !href && !useHistoryBack && 'cursor-default',
    useHistoryBack && 'cursor-pointer',
    variant === 'pill' && 'rounded-xl',
    className
  )}
  href={useHistoryBack ? undefined : href}
  data-astro-prefetch={useHistoryBack ? undefined : true}
  data-history-back={useHistoryBack ? true : undefined}
  {...props}
>
  <slot name='before'>
    {
      variant === 'back' && (
        <svg
          xmlns='http://www.w3.org/2000/svg'
          width='16'
          height='16'
          viewBox='0 0 24 24'
          fill='none'
          stroke-width='2.5'
          stroke-linecap='round'
          stroke-linejoin='round'
          class='stroke-muted-foreground group-hover:stroke-primary'
        >
          <line
            x1='19'
            y1='12'
            x2='5'
            y2='12'
            class='translate-x-3 scale-x-0 transition-all duration-300 ease-in-out group-hover:translate-x-0 group-hover:scale-x-100'
          />
          <polyline
            points='12 19 5 12 12 5'
            class='translate-x-1 transition-all duration-300 ease-in-out group-hover:translate-x-0'
          />
        </svg>
      )
    }
  </slot>
  <slot>
    {title && <p class='my-0'>{title}</p>}
  </slot>
  <slot name='after'>
    {
      variant === 'ahead' && (
        <svg
          xmlns='http://www.w3.org/2000/svg'
          width='16'
          height='16'
          viewBox='0 0 24 24'
          fill='none'
          stroke-width='2.5'
          stroke-linecap='round'
          stroke-linejoin='round'
          class='stroke-muted-foreground group-hover:stroke-primary'
        >
          <line
            x1='5'
            y1='12'
            x2='19'
            y2='12'
            class='translate-x-4 scale-x-0 transition-all duration-300 ease-in-out group-hover:translate-x-1 group-hover:scale-x-100'
          />
          <polyline
            points='12 5 19 12 12 19'
            class='translate-x-0 transition-all duration-300 ease-in-out group-hover:translate-x-1'
          />
        </svg>
      )
    }
  </slot>
</Tag>

<script>
  document.querySelectorAll('[data-history-back]').forEach((el) => {
    el.addEventListener('click', (e) => {
      e.preventDefault()
      if (window.history.length > 1) {
        window.history.back()
      } else {
        // Fallback to home if no history
        window.location.href = '/'
      }
    })
  })
</script>
