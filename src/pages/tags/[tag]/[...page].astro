---
import type { GetStaticPaths, Page } from 'astro'
import type { CollectionEntry } from 'astro:content'

import { Paginator, PostPreview } from 'astro-pure/components/pages'
import { getBlogCollection, getUniqueTagsBySlug, sortMDByDate } from 'astro-pure/server'
import { Button, Icon } from 'astro-pure/user'
import { tagToSlug } from 'astro-pure/utils'
import PageLayout from '@/layouts/BaseLayout.astro'
import config from '@/site-config'
import { getPublicationTagsBySlug, getPublicationsByTagSlug } from '@/data/publications'

export const prerender = true

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const allPosts = await getBlogCollection()
  const allPostsByDate = sortMDByDate(allPosts)
  const blogTags = getUniqueTagsBySlug(allPostsByDate)
  const publicationTags = getPublicationTagsBySlug()
  const uniqueTags = Array.from(
    new Map([...blogTags, ...publicationTags].map((t) => [t.slug, t])).values()
  )

  const paths: Array<{ params: { tag: string; page?: string }; props: Props }> = []

  uniqueTags.forEach(({ slug, label }) => {
    const filterPosts = allPostsByDate.filter((post) => post.data.tags.some((t) => tagToSlug(t) === slug))
    if (filterPosts.length === 0) {
      paths.push({
        params: { tag: slug },
        props: { page: null, tagLabel: label }
      })
      return
    }
    const paginated = paginate(filterPosts, {
      pageSize: config.content.blogPageSize,
      params: { tag: slug },
      props: { tagLabel: label }
    })
    paginated.forEach((path) => {
      paths.push(path as { params: { tag: string; page?: string }; props: Props })
    })
  })

  return paths
}

interface Props extends Record<string, unknown> {
  page: Page<CollectionEntry<'blog'>> | null
  tagLabel: string
}

const { page, tagLabel } = Astro.props
const tagSlug = String(Astro.params.tag ?? '')
const publications = tagSlug ? getPublicationsByTagSlug(tagSlug) : []
const publicationsByYear = [...publications].sort((a, b) => Number(b.year) - Number(a.year))

const meta = {
  description: `View all posts and publications with the tag - ${tagLabel}`,
  title: `Tag: ${tagLabel}`
}

const paginationProps = {
  ...(page?.url.prev && {
    prevUrl: {
      text: `← Previous Tags`,
      url: page.url.prev
    }
  }),
  ...(page?.url.next && {
    nextUrl: {
      text: `Next Tags →`,
      url: page.url.next
    }
  })
}
---

<PageLayout {meta}>
  <Button title='Back' variant='back' useHistoryBack />
  <main class='mt-6 lg:mt-10'>
    <div id='content-header' class='animate'>
      <h1 class='mb-6 flex items-end gap-x-2 text-3xl font-medium'>
        Tags:
        <span class='text-2xl'>#{tagLabel}</span>
      </h1>
    </div>

    <section id='content' class='animate' aria-label='Publications list'>
      {publicationsByYear.length > 0 && (
        <div class='mb-10'>
          <h2 class='mb-4 flex items-center text-lg font-medium'>
            <Icon name='document' class='me-2' />
            Publications
          </h2>
          <ul class='flex flex-col gap-y-4'>
            {publicationsByYear.map((pub) => (
              <li class='rounded-2xl border bg-background px-5 py-4'>
                <div class='flex flex-col gap-2'>
                  <h3 class='text-base font-medium leading-tight'>{pub.title}</h3>
                  <div class='text-sm text-muted-foreground'>
                    <span set:html={pub.authors} />
                  </div>
                  <div class='text-sm text-muted-foreground'>
                    <span class='font-medium'>{pub.venue}</span>
                    <span class='mx-1'>•</span>
                    <span>{pub.year}</span>
                  </div>
                  {pub.links && pub.links.length > 0 && (
                    <div class='flex flex-wrap gap-3 pt-1'>
                      {pub.links.map((link) => (
                        <a
                          href={link.href}
                          class='text-xs font-medium uppercase tracking-wider hover:text-primary transition-colors inline-flex items-center gap-1'
                          target={link.href.startsWith('http') ? '_blank' : undefined}
                          rel={link.href.startsWith('http') ? 'noopener noreferrer' : undefined}
                        >
                          <Icon
                            name={link.label.toLowerCase().includes('code') ? 'github' : 'link'}
                            size='0.75rem'
                          />
                          {link.label}
                        </a>
                      ))}
                    </div>
                  )}
                </div>
              </li>
            ))}
          </ul>
        </div>
      )}

      <div>
        <h2 class='mb-4 flex items-center text-lg font-medium'>
          <Icon name='tag-2' class='me-2' />
          Blog Posts
        </h2>
        {page?.data.length ? (
          <>
            <ul class='flex flex-col gap-y-3 text-start'>
              {page.data.map((post) => <PostPreview {post} detailed />)}
            </ul>
            <Paginator {...paginationProps} />
          </>
        ) : (
          <p class='text-muted-foreground'>No blog posts yet.</p>
        )}
      </div>
    </section>
  </main>
</PageLayout>
